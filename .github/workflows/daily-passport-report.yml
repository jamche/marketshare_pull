name: Daily Honda Passport Report

on:
  schedule:
    # Runs daily at 14:00 UTC (~09:00 ET when not in DST; adjust if needed)
    - cron: "0 14 * * *"
  workflow_dispatch: {}

jobs:
  run-daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      MARKETCHECK_API_KEY: ${{ secrets.MARKETCHECK_API_KEY }}
      CAR_SEARCH_COUNTRY: ${{ vars.CAR_SEARCH_COUNTRY || 'CA' }}
      CAR_SEARCH_STATE: ${{ vars.CAR_SEARCH_STATE || '' }}
      CAR_SEARCH_ZIP: ${{ vars.CAR_SEARCH_ZIP || '' }}
      CAR_SEARCH_RADIUS_MILES: ${{ vars.CAR_SEARCH_RADIUS_MILES || '100' }}
      CAR_SEARCH_YEARS: ${{ vars.CAR_SEARCH_YEARS || '' }}
      MAX_LISTINGS: ${{ vars.MAX_LISTINGS || '50' }}

      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ vars.SMTP_PORT || '587' }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}

      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_TABLE: ${{ vars.SUPABASE_TABLE || 'passport_listings' }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run daily Passport report
        run: |
          python daily_passport_report.py
